{% extends 'base.html' %}
{% load static %}
{% load markdown_filters %}

{% block on_page_css %}
<link rel="stylesheet" type="text/css" media="all" href="{% static 'css/style.css' %}">
{% endblock on_page_css %}

{% block content %}
<div class="chat-container">
    <div id="qa-container" class="col-md-11 col-xl-11 mx-4">
        <h2 id="conversation-title">
            {% if conversation.title %}{{ conversation.title|truncatechars:40 }}{% else %}Untitled Conversation{% endif %}
        </h2>
        <hr>

        {% if previous_messages %}
            {% for message in previous_messages %}
                <div id="qa-pair-{{ forloop.counter }}" class="qa-pair">
                    {% if message.is_from_user %}
                        <div class="question-area d-flex justify-content-end">
                            {% if message.content_type == 'AU' %}
                                <div class="audio-message">
                                    <audio controls src="{{ message.voice_content.audio_file.url }}"></audio>
                                    <span>{{ message.voice_content.transcript }}</span>
                                </div>
                            {% else %}
                                <p>{{ message.chat_content.content }}</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="card">
                            <div class="card-body">
                                <div class="answer-area">
                                    <div class="message-content">
                                        {% if message.content_type == 'AU' %}
                                            <div class="audio-message">
                                                <audio controls src="{{ message.voice_content.audio_file.url }}"></audio>
                                                <span>{{ message.voice_content.transcript }}</span>
                                            </div>
                                        {% else %}
                                            {{ message.chat_content.content|markdown_to_html|safe }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <div class="input-group mb-1 fixed-bottom-input bg-light">
        <div class="audio-controls">
            <button id="startRecording" class="btn btn-primary">Start Recording</button>
            <button id="stopRecording" class="btn btn-danger" disabled>Stop Recording</button>
        </div>
        <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
        <button id="sendMessage" class="btn btn-primary">Send</button>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/recorderjs/0.1.0/recorder.js"></script>
<script>
    let mediaRecorder;
    let audioChunks = [];
    const startRecordingButton = document.getElementById('startRecording');
    const stopRecordingButton = document.getElementById('stopRecording');
    const messageInput = document.getElementById('messageInput');
    const sendMessageButton = document.getElementById('sendMessage');
    const qaContainer = document.getElementById('qa-container');
    const conversationTitle = document.getElementById('conversation-title');

    let chatSocket;

    function connectWebSocket() {
        const conversationId = '{{ conversation.id }}';
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsPath = `${wsScheme}://${window.location.host}/ws/chat/${conversationId}/`;
        
        chatSocket = new WebSocket(wsPath);

        chatSocket.onopen = function(e) {
            console.log('WebSocket connection established');
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            handleWebSocketMessage(data);
        };

        chatSocket.onclose = function(e) {
            console.error('WebSocket closed unexpectedly');
        };
    }

    function handleWebSocketMessage(data) {
        if (data.type === 'welcome') {
            console.log(data.message);
        } else if (data.type === 'title_update') {
            conversationTitle.textContent = data.title;
        } else if (data.event === 'on_parser_stream' || data.event === 'on_parser_end') {
            updateOrCreateMessage(data);
        }
    }

    function updateOrCreateMessage(data) {
        let messageElement = document.getElementById(`message-${data.id}`);
        if (!messageElement) {
            messageElement = document.createElement('div');
            messageElement.id = `message-${data.id}`;
            messageElement.className = 'card mb-3';
            qaContainer.appendChild(messageElement);
        }

        if (data.content_type === 'AU') {
            messageElement.innerHTML = `
                <div class="card-body">
                    <div class="audio-message">
                        <audio controls src="${data.audio_url}"></audio>
                        <span>${data.transcript}</span>
                    </div>
                </div>
            `;
        } else {
            messageElement.innerHTML = `
                <div class="card-body">
                    <div class="message-content">${marked(data.content)}</div>
                </div>
            `;
        }

        qaContainer.scrollTop = qaContainer.scrollHeight;
    }

    startRecordingButton.onclick = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();

        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        startRecordingButton.disabled = true;
        stopRecordingButton.disabled = false;
    };

    stopRecordingButton.onclick = () => {
        mediaRecorder.stop();
        startRecordingButton.disabled = false;
        stopRecordingButton.disabled = true;
    };

    mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        audioChunks = [];
        sendAudioMessage(audioBlob);
    };

    function sendAudioMessage(audioBlob) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Audio = e.target.result.split(',')[1];
            chatSocket.send(JSON.stringify({
                'type': 'AU',
                'message': base64Audio,
                'uuid': '{{ conversation.id }}'
            }));
        };
        reader.readAsDataURL(audioBlob);
    }

    sendMessageButton.onclick = function(e) {
        const message = messageInput.value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({
                'type': 'TE',
                'message': message,
                'uuid': '{{ conversation.id }}'
            }));
            messageInput.value = '';
        }
    };

    messageInput.onkeyup = function(e) {
        if (e.key === 'Enter') {
            sendMessageButton.click();
        }
    };

    // Connect WebSocket when the page loads
    connectWebSocket();
</script>
{% endblock extra_js %}